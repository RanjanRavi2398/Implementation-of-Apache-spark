{"version":"NotebookV1","origId":4259324615413988,"name":"utilities","language":"python","commands":[{"version":"CommandV1","origId":4259324615413989,"guid":"a2fdb819-c375-40d6-94dd-2a11b3380d63","subtype":"command","commandType":"auto","position":1.0,"command":"\nfrom pyspark.sql import SparkSession\nfrom urllib.request import urlretrieve","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"579109183679732","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"eedce65f-fc34-4635-89ca-0ded9ed93c82"},{"version":"CommandV1","origId":4259324615413990,"guid":"f0d108f8-ac0d-4288-b755-7f8e73a490c2","subtype":"command","commandType":"auto","position":2.0,"command":"%md\n### Include configuration notebook","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"579109183679732","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"50bb8c1b-43fc-4bbc-8305-3271f3a794ce"},{"version":"CommandV1","origId":4259324615413991,"guid":"123c6663-3024-4717-8df0-890573e7b393","subtype":"command","commandType":"auto","position":3.0,"command":"%run ./configuration","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"579109183679732","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"95b8ea48-de17-4e28-8dea-4352d47e23ea"},{"version":"CommandV1","origId":4259324615413992,"guid":"97d9313e-8b30-4d76-801a-77a78fc9cc5d","subtype":"command","commandType":"auto","position":4.0,"command":"def retrieve_data(file: str) -> bool:\n  \"\"\"Download file from remote location to driver. Move from driver to DBFS.\"\"\"\n\n  base_url = \"https://files.training.databricks.com/static/data/health-tracker/\"\n  url = base_url + file\n  driverPath = \"file:/databricks/driver/\" + file\n  dbfsPath   = landingPath + file\n  urlretrieve(url, file)\n  dbutils.fs.mv(driverPath , dbfsPath)\n  return True\n\ndef load_delta_table(file: str, delta_table_path: str) -> bool:\n  \"Load a parquet file as a Delta table.\"\n  parquet_df = spark.read.format(\"parquet\").load(landingPath + file)\n  parquet_df.write.format(\"delta\").save(delta_table_path)\n  return True\n\ndef process_file(file_name: str, path: str,  table_name: str) -> bool:\n  \"\"\"\n  1. retrieve file\n  2. load as delta table\n  3. register table in the metastore\n  \"\"\"\n\n  retrieve_data(file_name)\n  print(f\"Retrieve {file_name}.\")\n\n  load_delta_table(file_name, path)\n  print(f\"Load {file_name} to {path}\")\n\n  spark.sql(f\"\"\"\n  DROP TABLE IF EXISTS {table_name}\n  \"\"\")\n\n  spark.sql(f\"\"\"\n  CREATE TABLE {table_name}\n  USING DELTA\n  LOCATION \"{path}\"\n  \"\"\")\n\n  print(f\"Register {table_name} using path: {path}\")\n","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"579109183679732","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"4ef67b39-dc9f-466f-89a1-2bbd3bc07557"}],"dashboards":[],"guid":"be0c1575-ff7c-45a1-8dae-bff84d669d2c","globalVars":{},"iPythonMetadata":null,"inputWidgets":{}}