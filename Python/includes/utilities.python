{"version":"NotebookV1","origId":4259324615413647,"name":"utilities","language":"python","commands":[{"version":"CommandV1","origId":4259324615413648,"guid":"a193614a-1865-4a4e-908a-a00e4f9cdfa8","subtype":"command","commandType":"auto","position":1.0,"command":"\nfrom pyspark.sql import SparkSession\nfrom urllib.request import urlretrieve","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"579109183679732","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"d136c189-7433-4dc9-a1c1-167e1455dbea"},{"version":"CommandV1","origId":4259324615413649,"guid":"93ba3d82-08e9-4b0f-8820-cbb78ace430e","subtype":"command","commandType":"auto","position":2.0,"command":"%md\n### Include configuration notebook","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"579109183679732","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"5dd97336-ae16-49df-a0e9-08c9721c07be"},{"version":"CommandV1","origId":4259324615413650,"guid":"c5e52e02-da7d-4a9f-b570-0d58e53ca2d0","subtype":"command","commandType":"auto","position":3.0,"command":"%run ./configuration","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"579109183679732","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"8cd3f4e2-6d38-47d6-9f10-82968cd87674"},{"version":"CommandV1","origId":4259324615413651,"guid":"7f206342-e6fd-40a3-bca7-4f2b014c8a56","subtype":"command","commandType":"auto","position":4.0,"command":"def retrieve_data(file: str) -> bool:\n  \"\"\"Download file from remote location to driver. Move from driver to DBFS.\"\"\"\n\n  base_url = \"https://files.training.databricks.com/static/data/health-tracker/\"\n  url = base_url + file\n  driverPath = \"file:/databricks/driver/\" + file\n  dbfsPath   = landingPath + file\n  urlretrieve(url, file)\n  dbutils.fs.mv(driverPath , dbfsPath)\n  return True\n\ndef load_delta_table(file: str, delta_table_path: str) -> bool:\n  \"Load a parquet file as a Delta table.\"\n  parquet_df = spark.read.format(\"parquet\").load(landingPath + file)\n  parquet_df.write.format(\"delta\").save(delta_table_path)\n  return True\n\ndef process_file(file_name: str, path: str,  table_name: str) -> bool:\n  \"\"\"\n  1. retrieve file\n  2. load as delta table\n  3. register table in the metastore\n  \"\"\"\n\n  retrieve_data(file_name)\n  print(f\"Retrieve {file_name}.\")\n\n  load_delta_table(file_name, path)\n  print(f\"Load {file_name} to {path}\")\n\n  spark.sql(f\"\"\"\n  DROP TABLE IF EXISTS {table_name}\n  \"\"\")\n\n  spark.sql(f\"\"\"\n  CREATE TABLE {table_name}\n  USING DELTA\n  LOCATION \"{path}\"\n  \"\"\")\n\n  print(f\"Register {table_name} using path: {path}\")\n","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":"579109183679732","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"2a45b9f1-5b80-4fa9-b78c-a0a4825a25bf"}],"dashboards":[],"guid":"623ba881-9914-432a-b536-1329c56e3677","globalVars":{},"iPythonMetadata":null,"inputWidgets":{}}